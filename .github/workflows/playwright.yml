  name: Playwright Tests
  on:
    workflow_dispatch:
      inputs:
        browser:
          description: 'Choose the browser to run tests on (chromium, webkit)'
          required: true
          default: 'chromium'
          type: choice
          options:
            - chromium
            - webkit
  jobs:
    run-tests:
      timeout-minutes: 180
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
        - name: Set up Python
          uses: actions/setup-python@v4
          with:
            python-version: '3.11'
        - name: Install dependencies
          run: |
            apt-get update && \
            apt-get install -y wget xvfb default-jre && \
            python -m pip install --upgrade pip && \
            pip install -r requirements.txt && \
            wget https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz && \
            tar -zxvf allure-2.25.0.tgz -C /opt/ && \
            ln -s /opt/allure-2.25.0/bin/allure /usr/local/bin/allure && \
            chmod +x /usr/local/bin/allure
            python -m pip install --upgrade pip
            pip install -r requirements.txt

        - name: Ensure browsers are installed
          run: python -m playwright install --with-deps

        - name: Run your tests
          env:
            BROWSER: ${{ github.event.inputs.browser }}
            STAGE_URL: ${STAGE_URL}
            STAGE_ADMIN_LINK: ${STAGE_ADMIN_LINK}
            STAGE_ADMIN_EMAIL: ${STAGE_ADMIN_EMAIL}
            STAGE_ADMIN_PASSWORD: ${STAGE_ADMIN_PASSWORD}
          run: xvfb-run -a pytest tests/test-debug.py -sv -n 10 --alluredir=allure-results/ --browser_name=${BROWSER}

        - name: Load test report history
          uses: actions/checkout@v3
          if: always()
          continue-on-error: true
          with:
            ref: gh-pages
            path: gh-pages

        - name: Build test report
          uses: simple-elf/allure-report-action@v1.7
          if: always()
          with:
            gh_pages: gh-pages
            allure_history: allure-history
            allure_results: build/allure-results/

        - name: Publish test report
          uses: peaceiris/actions-gh-pages@v3
          if: always()
          with:
            github_token: ${{ secrets.CI_TOKEN }}
            publish_branch: gh-pages
            publish_dir: allure-history
            keep_files: 'true'
